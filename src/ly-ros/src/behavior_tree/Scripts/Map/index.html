<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>坐标读取 & 预置点展示（两组坐标）</title>
<style>
  body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5}
  .container{max-width:820px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15)}
  h1{text-align:center;font-size:22px;margin-top:0}
  .image-container{position:relative;margin:20px 0;border:1px solid #ccc;display:inline-block}
  #map-image{display:block;max-width:100%;cursor:crosshair}
  #dot-layer,#presets-layer{position:absolute;left:0;top:0;pointer-events:auto;cursor:crosshair;z-index:2;}
  #dot-layer{z-index:2} #presets-layer{z-index:3}
  #coordinates,#hoverTip{position:absolute;background:rgba(0,0,0,.75);color:#fff;padding:4px 8px;border-radius:4px;font-size:13px;pointer-events:none;display:none;z-index:10}
  textarea{width:100%;height:140px;font-family:monospace;font-size:13px;resize:vertical}
  button{margin-top:6px}
  .info{font-size:14px;color:#555;margin-top:10px}
</style>
</head>
<body>
<div class="container">
  <h1>坐标读取 & 预置点展示（两组坐标）</h1>

  <input type="file" id="file-input" accept="image/*" />

  <div class="image-container">
    <img id="map-image" />
    <canvas id="dot-layer"></canvas>
    <canvas id="presets-layer"></canvas>
    <div id="coordinates"></div>
    <div id="hoverTip"></div>
  </div>

  <textarea id="presetInput" placeholder="粘贴 C++ 格式坐标，例如：
Location<std::uint16_t> Home{{393,810},{2408,683}};
Location<std::uint16_t> Base{{401,691},{2400,811}};
..."></textarea>
  <button onclick="parseAndDrawPresets()">解析并绘制</button>

  <div class="info">
    左下角为(0,0)，横向X轴 0–28 m，纵向Y轴 0–15 m。<br>
    点击图出现红点（当前坐标）；蓝点为预置坐标，鼠标悬停查看名称 & 类型。
  </div>
</div>

<script>
/* ===== 基本常量 ===== */
const REAL_W = 28;   // m
const REAL_H = 15;   // m
const mapImg   = document.getElementById('map-image');
const dotLayer = document.getElementById('dot-layer');
const preLayer = document.getElementById('presets-layer');
const dCtx = dotLayer.getContext('2d');
const pCtx = preLayer.getContext('2d');
const coordBox = document.getElementById('coordinates');
const hoverBox = document.getElementById('hoverTip');

let presetPoints = [];   // {name, type, px, py, screenX, screenY}

/* ===== 画布同步 ===== */
function resizeCanvases() {
  [dotLayer, preLayer].forEach(c => {
    c.width  = mapImg.clientWidth;
    c.height = mapImg.clientHeight;
  });
  drawPresets();
}
mapImg.addEventListener('load', resizeCanvases);
window.addEventListener('resize', resizeCanvases);

/* ===== 上传图片 ===== */
document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { mapImg.src = ev.target.result; };
  reader.readAsDataURL(file);
});

/* ===== 点击地图取坐标 ===== */
preLayer.addEventListener('click', e => {
  const rect = mapImg.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  console.log(`x: ${x}, y: ${y}`);

  dCtx.clearRect(0, 0, dotLayer.width, dotLayer.height);
  dCtx.beginPath();
  dCtx.arc(x, y, 4, 0, Math.PI * 2);
  dCtx.fillStyle = 'red';
  dCtx.fill();

  const cmX = Math.round((x / mapImg.clientWidth)  * REAL_W * 100);
  const cmY = Math.round((1 - y / mapImg.clientHeight) * REAL_H * 100);
  showTip(coordBox, x, y, `(${cmX} cm, ${cmY} cm)`);
});

/* ===== 解析并绘制两组坐标 ===== */
function parseAndDrawPresets() {
  const text = document.getElementById('presetInput').value;
  const regex = /Location<[^>]+>\s+(\w+)\{\s*\{(\d+),\s*(\d+)\}\s*,\s*\{(\d+),\s*(\d+)\}\s*\}/g;
  presetPoints = [];
  let m;
  while ((m = regex.exec(text)) !== null) {
    const name = m[1];
    const x1 = +m[2], y1 = +m[3];
    const x2 = +m[4], y2 = +m[5];
    presetPoints.push(
      { name, type: '红方', px: x1, py: y1, color: 'red' },
      { name, type: '蓝方', px: x2, py: y2, color: 'blue' }
    );
  }
  drawPresets();
}

function drawPresets() {
  pCtx.clearRect(0, 0, preLayer.width, preLayer.height);
  presetPoints.forEach(p => {
    const x = (p.px / 2800) * preLayer.width;
    const y = preLayer.height - (p.py / 1500) * preLayer.height;
    pCtx.beginPath();
    pCtx.arc(x, y, 5, 0, Math.PI * 2);
    pCtx.fillStyle = p.color;
    pCtx.fill();
    pCtx.strokeStyle = 'white';
    pCtx.lineWidth = 1.5;
    pCtx.stroke();
    p.screenX = x;
    p.screenY = y;
  });
}

/* ===== 鼠标悬停提示 ===== */
preLayer.addEventListener('mousemove', e => {
  const rect = preLayer.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  // console.log(mx, my);
  const found = presetPoints.find(p => Math.hypot(mx - p.screenX, my - p.screenY) <= 6);
  if (found) {
    showTip(hoverBox, mx, my, `${found.name} ${found.type} (${found.px}, ${found.py})`);
  } else {
    hoverBox.style.display = 'none';
  }
});
preLayer.addEventListener('mouseleave', () => hoverBox.style.display = 'none');

/* ===== 通用提示框 ===== */
function showTip(box, x, y, text) {
  box.textContent = text;
  box.style.display = 'block';
  const bw = box.offsetWidth, bh = box.offsetHeight;
  let tx = x + 10, ty = y - bh - 10;
  if (tx + bw > mapImg.clientWidth) tx = x - bw - 10;
  if (ty < 0) ty = y + 15;
  box.style.left = `${tx}px`;
  box.style.top = `${ty}px`;
}
</script>
</body>
</html>